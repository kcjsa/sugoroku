<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>EduTetsu å®Œå…¨ç‰ˆ - 47éƒ½é“åºœçœŒã™ã”ã‚ã</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f4f9; margin:0; }
  #container { display:flex; height: 100vh; }
  #game-area { flex: 3; background: #e0f0ff; position: relative; }
  #ui-area { flex: 1; background: #fff; padding: 15px; box-sizing: border-box; overflow-y: auto; border-left: 2px solid #ccc; }
  canvas { background: #b0d4f1; display: block; margin: 20px auto; border: 2px solid #333; border-radius: 8px; }
  h1 { margin-top: 0; color:#004080; text-align:center; }
  #log { height: 250px; background: #eee; overflow-y: auto; border: 1px solid #ccc; padding: 5px; font-size: 14px; line-height:1.3em; }
  button { font-size: 16px; padding: 8px 12px; margin: 8px 5px; cursor: pointer; border-radius: 5px; border: none; background:#0078d7; color:#fff; transition: 0.3s; }
  button:disabled { background:#aaa; cursor: not-allowed; }
  button:hover:not(:disabled) { background:#005a9e; }
  #player-info { margin-bottom: 10px; }
  .property { background: #d0ebff; border: 1px solid #0078d7; border-radius: 4px; padding: 3px 6px; margin: 2px 0; font-size: 14px; }
  #cards { margin-top: 10px; }
  .card { display: inline-block; background: #fff; border: 1px solid #0078d7; border-radius: 5px; padding: 5px 10px; margin: 3px; cursor: pointer; user-select:none; }
  .card.used { opacity: 0.4; cursor: default; }
  #quiz-box { margin-top: 15px; background:#e7f3ff; padding:10px; border-radius: 8px; display:none; }
  #quiz-box p { margin: 6px 0; font-weight: bold; }
  #quiz-answer { width: 80%; padding: 5px; font-size: 16px; }
</style>
</head>
<body>
<div id="container">
  <div id="game-area">
    <h1>EduTetsu - æ•™è‚²ã™ã”ã‚ãå®Œå…¨ç‰ˆ</h1>
    <canvas id="mapCanvas" width="900" height="700"></canvas>
  </div>
  <div id="ui-area">
    <div id="player-info"></div>
    <button id="rollDiceBtn">ğŸ² ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
    <button id="endTurnBtn" disabled>ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
    <button id="buyPropertyBtn" disabled>ç‰©ä»¶è³¼å…¥</button>
    <div id="cards"></div>

    <div id="quiz-box">
      <p id="quiz-question"></p>
      <input type="text" id="quiz-answer" placeholder="ç­”ãˆã‚’å…¥åŠ›" autocomplete="off" />
      <button id="submitQuizBtn">å›ç­”ã™ã‚‹</button>
      <p id="quiz-feedback"></p>
    </div>

    <h3>ã‚²ãƒ¼ãƒ ãƒ­ã‚°</h3>
    <div id="log"></div>
  </div>
</div>

<script>
// === éƒ½é“åºœçœŒé§…ãƒ‡ãƒ¼ã‚¿ ===
const stations = [
  { name:"åŒ—æµ·é“", x:450, y:60, price:3500 },
  { name:"é’æ£®", x:510, y:130, price:2200 },
  { name:"å²©æ‰‹", x:560, y:170, price:2100 },
  { name:"å®®åŸ", x:600, y:200, price:2300 },
  { name:"ç§‹ç”°", x:540, y:210, price:2000 },
  { name:"å±±å½¢", x:590, y:230, price:2200 },
  { name:"ç¦å³¶", x:620, y:260, price:2400 },
  { name:"èŒ¨åŸ", x:650, y:310, price:2100 },
  { name:"æ ƒæœ¨", x:630, y:290, price:2000 },
  { name:"ç¾¤é¦¬", x:610, y:300, price:2100 },
  { name:"åŸ¼ç‰", x:600, y:320, price:2500 },
  { name:"åƒè‘‰", x:670, y:340, price:2500 },
  { name:"æ±äº¬", x:620, y:350, price:3000 },
  { name:"ç¥å¥ˆå·", x:600, y:380, price:2700 },
  { name:"æ–°æ½Ÿ", x:570, y:280, price:2300 },
  { name:"å¯Œå±±", x:520, y:300, price:2100 },
  { name:"çŸ³å·", x:500, y:320, price:2200 },
  { name:"ç¦äº•", x:480, y:340, price:2100 },
  { name:"å±±æ¢¨", x:580, y:350, price:2300 },
  { name:"é•·é‡", x:550, y:360, price:2300 },
  { name:"å²é˜œ", x:510, y:370, price:2400 },
  { name:"é™å²¡", x:570, y:410, price:2400 },
  { name:"æ„›çŸ¥", x:540, y:400, price:2800 },
  { name:"ä¸‰é‡", x:520, y:420, price:2300 },
  { name:"æ»‹è³€", x:500, y:430, price:2100 },
  { name:"äº¬éƒ½", x:480, y:450, price:2500 },
  { name:"å¤§é˜ª", x:460, y:470, price:3000 },
  { name:"å…µåº«", x:420, y:460, price:2500 },
  { name:"å¥ˆè‰¯", x:460, y:490, price:2100 },
  { name:"å’Œæ­Œå±±", x:480, y:510, price:2000 },
  { name:"é³¥å–", x:400, y:490, price:2100 },
  { name:"å³¶æ ¹", x:360, y:490, price:2000 },
  { name:"å²¡å±±", x:380, y:520, price:2200 },
  { name:"åºƒå³¶", x:350, y:530, price:2500 },
  { name:"å±±å£", x:300, y:540, price:2300 },
  { name:"å¾³å³¶", x:470, y:540, price:2000 },
  { name:"é¦™å·", x:460, y:560, price:2100 },
  { name:"æ„›åª›", x:430, y:570, price:2100 },
  { name:"é«˜çŸ¥", x:420, y:590, price:2000 },
  { name:"ç¦å²¡", x:320, y:520, price:2800 },
  { name:"ä½è³€", x:300, y:510, price:2000 },
  { name:"é•·å´", x:260, y:520, price:2100 },
  { name:"ç†Šæœ¬", x:270, y:540, price:2200 },
  { name:"å¤§åˆ†", x:310, y:560, price:2100 },
  { name:"å®®å´", x:350, y:570, price:2000 },
  { name:"é¹¿å…å³¶", x:250, y:580, price:2400 },
  { name:"æ²–ç¸„", x:120, y:620, price:3000 }
];

// === 47éƒ½é“åºœçœŒã‚¯ã‚¤ã‚ºï¼ˆå•é¡Œã¨æ­£è§£ï¼‰===
const quizzes = {
  "åŒ—æµ·é“": { question:"åŒ—æµ·é“ã®æœ‰åãªæ–™ç†ã¯ä½•ã§ã™ã‹ï¼Ÿ", answer:"ã‚¸ãƒ³ã‚®ã‚¹ã‚«ãƒ³" },
  "é’æ£®": { question:"é’æ£®çœŒã®æœ‰åãªç¥­ã‚Šã¯ä½•ã§ã™ã‹ï¼Ÿ", answer:"ã­ã¶ãŸç¥­ã‚Š" },
  "å²©æ‰‹": { question:"å²©æ‰‹çœŒã®ä¸–ç•Œéºç”£ã¯ä½•ã§ã™ã‹ï¼Ÿ", answer:"å¹³æ³‰" },
  "å®®åŸ": { question:"å®®åŸçœŒã®åç‰©ã§ç‰›ã‚¿ãƒ³ä»¥å¤–ã«æœ‰åãªã‚‚ã®ã¯ï¼Ÿ", answer:"ç¬¹ã‹ã¾ã¼ã“" },
  "ç§‹ç”°": { question:"ç§‹ç”°çœŒã®ä¼çµ±çš„ãªè¸Šã‚Šã¯ï¼Ÿ", answer:"ç«¿ç‡ˆç¥­ã‚Š" },
  "å±±å½¢": { question:"å±±å½¢çœŒã®ã•ãã‚‰ã‚“ã¼ã®å“ç¨®ã¯ï¼Ÿ", answer:"ä½è—¤éŒ¦" },
  "ç¦å³¶": { question:"ç¦å³¶çœŒã®æ¸©æ³‰åœ°ã¯ã©ã“ï¼Ÿ", answer:"ä¼šæ´¥è‹¥æ¾" },
  "èŒ¨åŸ": { question:"èŒ¨åŸçœŒã®å•æ¥½åœ’ã§æœ‰åãªèŠ±ã¯ï¼Ÿ", answer:"æ¢…" },
  "æ ƒæœ¨": { question:"æ ƒæœ¨çœŒã®æœ‰åãªé¤ƒå­ã®è¡—ã¯ï¼Ÿ", answer:"å®‡éƒ½å®®" },
  "ç¾¤é¦¬": { question:"ç¾¤é¦¬çœŒã®åç‰©æ¸©æ³‰ã¯ï¼Ÿ", answer:"è‰æ´¥æ¸©æ³‰" },
  "åŸ¼ç‰": { question:"åŸ¼ç‰çœŒã®æœ‰åãªé‰„é“åšç‰©é¤¨ã¯ï¼Ÿ", answer:"é‰„é“åšç‰©é¤¨" },
  "åƒè‘‰": { question:"åƒè‘‰çœŒã®ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒªã‚¾ãƒ¼ãƒˆã®æ­£å¼åç§°ã¯ï¼Ÿ", answer:"æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒªã‚¾ãƒ¼ãƒˆ" },
  "æ±äº¬": { question:"æ±äº¬ã®éƒ½åºãŒã‚ã‚‹ã®ã¯ã©ã®åŒºï¼Ÿ", answer:"æ–°å®¿åŒº" },
  "ç¥å¥ˆå·": { question:"ç¥å¥ˆå·çœŒã®æœ‰åãªä¸­è¯è¡—ã¯ï¼Ÿ", answer:"æ¨ªæµœä¸­è¯è¡—" },
  "æ–°æ½Ÿ": { question:"æ–°æ½ŸçœŒã®æœ‰åãªç±³ã®å“ç¨®ã¯ï¼Ÿ", answer:"ã‚³ã‚·ãƒ’ã‚«ãƒª" },
  "å¯Œå±±": { question:"å¯Œå±±çœŒã®æœ‰åãªè–¬å£²ã‚Šã§ä½¿ã†å‹•ç‰©ã¯ï¼Ÿ", answer:"é¦¬" },
  "çŸ³å·": { question:"çŸ³å·çœŒã®é‡‘æ²¢å¸‚ã§æœ‰åãªåº­åœ’ã¯ï¼Ÿ", answer:"å…¼å…­åœ’" },
  "ç¦äº•": { question:"ç¦äº•çœŒã®æç«œåšç‰©é¤¨ã®æç«œã¯ï¼Ÿ", answer:"ãƒ†ã‚£ãƒ©ãƒã‚µã‚¦ãƒ«ã‚¹" },
  "å±±æ¢¨": { question:"å±±æ¢¨çœŒã®ç‰¹ç”£å“ã§æœ‰åãªæœç‰©ã¯ï¼Ÿ", answer:"ã¶ã©ã†" },
  "é•·é‡": { question:"é•·é‡çœŒã®å–„å…‰å¯ºãŒã‚ã‚‹å¸‚ã¯ï¼Ÿ", answer:"é•·é‡å¸‚" },
  "å²é˜œ": { question:"å²é˜œçœŒã®æœ‰åãªåŸã¯ï¼Ÿ", answer:"å²é˜œåŸ" },
  "é™å²¡": { question:"é™å²¡çœŒã®åç”£èŒ¶ã¯ï¼Ÿ", answer:"é™å²¡èŒ¶" },
  "æ„›çŸ¥": { question:"æ„›çŸ¥çœŒã®æœ‰åãªç¥­ã‚Šã¯ï¼Ÿ", answer:"å±±è»Šç¥­ã‚Š" },
  "ä¸‰é‡": { question:"ä¸‰é‡çœŒã®ä¼Šå‹¢ç¥å®®ãŒã‚ã‚‹å¸‚ã¯ï¼Ÿ", answer:"ä¼Šå‹¢å¸‚" },
  "æ»‹è³€": { question:"æ»‹è³€çœŒã®å¤§ããªæ¹–ã¯ï¼Ÿ", answer:"çµç¶æ¹–" },
  "äº¬éƒ½": { question:"äº¬éƒ½åºœã®æœ‰åãªå¯ºã¯ï¼Ÿ", answer:"æ¸…æ°´å¯º" },
  "å¤§é˜ª": { question:"å¤§é˜ªåºœã®æœ‰åãªé£Ÿã¹ç‰©ã¯ï¼Ÿ", answer:"ãŸã“ç„¼ã" },
  "å…µåº«": { question:"å…µåº«çœŒã®ç¥æˆ¸ç‰›ã§æœ‰åãªå¸‚ã¯ï¼Ÿ", answer:"ç¥æˆ¸å¸‚" },
  "å¥ˆè‰¯": { question:"å¥ˆè‰¯çœŒã§æœ‰åãªå¤§ä»ã¯ã©ã“ï¼Ÿ", answer:"æ±å¤§å¯º" },
  "å’Œæ­Œå±±": { question:"å’Œæ­Œå±±çœŒã®æœ‰åãªåŸã¯ï¼Ÿ", answer:"å’Œæ­Œå±±åŸ" },
  "é³¥å–": { question:"é³¥å–çœŒã®æœ‰åãªç ‚ä¸˜ã¯ï¼Ÿ", answer:"é³¥å–ç ‚ä¸˜" },
  "å³¶æ ¹": { question:"å³¶æ ¹çœŒã®æœ‰åãªç¥ç¤¾ã¯ï¼Ÿ", answer:"å‡ºé›²å¤§ç¤¾" },
  "å²¡å±±": { question:"å²¡å±±çœŒã®æœ‰åãªæœç‰©ã¯ï¼Ÿ", answer:"ç™½æ¡ƒ" },
  "åºƒå³¶": { question:"åºƒå³¶çœŒã®æœ‰åãªåŸçˆ†ãƒ‰ãƒ¼ãƒ ã®ã‚ã‚‹å¸‚ã¯ï¼Ÿ", answer:"åºƒå³¶å¸‚" },
  "å±±å£": { question:"å±±å£çœŒã®æœ‰åãªæ©‹ã¯ï¼Ÿ", answer:"éŒ¦å¸¯æ©‹" },
  "å¾³å³¶": { question:"å¾³å³¶çœŒã®æœ‰åãªè¸Šã‚Šã¯ï¼Ÿ", answer:"é˜¿æ³¢è¸Šã‚Š" },
  "é¦™å·": { question:"é¦™å·çœŒã®æœ‰åãªã†ã©ã‚“ã¯ï¼Ÿ", answer:"è®ƒå²ã†ã©ã‚“" },
  "æ„›åª›": { question:"æ„›åª›çœŒã®ç‰¹ç”£ã¿ã‹ã‚“ã¯ï¼Ÿ", answer:"æ¸©å·ã¿ã‹ã‚“" },
  "é«˜çŸ¥": { question:"é«˜çŸ¥çœŒã®æœ‰åãªå‚æœ¬é¾é¦¬ã®å‡ºèº«åœ°ã¯ï¼Ÿ", answer:"é«˜çŸ¥å¸‚" },
  "ç¦å²¡": { question:"ç¦å²¡çœŒã®æœ‰åãªãƒ©ãƒ¼ãƒ¡ãƒ³ã¯ï¼Ÿ", answer:"åšå¤šãƒ©ãƒ¼ãƒ¡ãƒ³" },
  "ä½è³€": { question:"ä½è³€çœŒã®æœ‰åãªç„¼ãç‰©ã¯ï¼Ÿ", answer:"æœ‰ç”°ç„¼" },
  "é•·å´": { question:"é•·å´çœŒã®æœ‰åãªæ•™ä¼šã¯ï¼Ÿ", answer:"å¤§æµ¦å¤©ä¸»å ‚" },
  "ç†Šæœ¬": { question:"ç†Šæœ¬çœŒã®æœ‰åãªåŸã¯ï¼Ÿ", answer:"ç†Šæœ¬åŸ" },
  "å¤§åˆ†": { question:"å¤§åˆ†çœŒã®æœ‰åãªæ¸©æ³‰ã¯ï¼Ÿ", answer:"åˆ¥åºœæ¸©æ³‰" },
  "å®®å´": { question:"å®®å´çœŒã®æœ‰åãªè¦³å…‰åœ°ã¯ï¼Ÿ", answer:"é’å³¶" },
  "é¹¿å…å³¶": { question:"é¹¿å…å³¶çœŒã®æœ‰åãªç«å±±ã¯ï¼Ÿ", answer:"æ¡œå³¶" },
  "æ²–ç¸„": { question:"æ²–ç¸„çœŒã®æœ‰åãªä¼çµ±æ–™ç†ã¯ï¼Ÿ", answer:"ã‚´ãƒ¼ãƒ¤ãƒãƒ£ãƒ³ãƒ—ãƒ«ãƒ¼" }
};

// === ã‚«ãƒ¼ãƒ‰ï¼ˆåŠ¹æœä»˜ãï¼‰ ===
const cardsData = [
  {name:"ãƒã‚¤ãƒ³ãƒˆ2å€", desc:"æ¬¡ã®ã‚¯ã‚¤ã‚ºæ­£è§£æ™‚ãƒã‚¤ãƒ³ãƒˆ2å€", effect: (game) => { game.currentPlayer.nextQuizDouble = true; }},
  {name:"ã‚µã‚¤ã‚³ãƒ­+1", desc:"æ¬¡ã®ã‚µã‚¤ã‚³ãƒ­ã®ç›®ã«+1", effect: (game) => { game.currentPlayer.nextDiceBonus = 1; }},
  {name:"è²§ä¹ç¥å›é¿", desc:"æ¬¡ã®è²§ä¹ç¥ã®è¥²æ¥ã‚’å›é¿", effect: (game) => { game.currentPlayer.avoidPoorGod = true; }},
  {name:"æ¬¡ã‚¿ãƒ¼ãƒ³2å›è¡Œå‹•", desc:"æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã«ã‚µã‚¤ã‚³ãƒ­2å›æŒ¯ã‚Œã‚‹", effect: (game) => { game.currentPlayer.nextTurnDouble = true; }},
];

// === ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ– ===
const players = [
  {name:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1", color:"red", position:0, money:10000, properties:[], cards:[], nextQuizDouble:false, nextDiceBonus:0, avoidPoorGod:false, nextTurnDouble:false, movesLeft:1},
  {name:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2", color:"blue", position:0, money:10000, properties:[], cards:[], nextQuizDouble:false, nextDiceBonus:0, avoidPoorGod:false, nextTurnDouble:false, movesLeft:1},
  {name:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3", color:"green", position:0, money:10000, properties:[], cards:[], nextQuizDouble:false, nextDiceBonus:0, avoidPoorGod:false, nextTurnDouble:false, movesLeft:1},
  {name:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4", color:"purple", position:0, money:10000, properties:[], cards:[], nextQuizDouble:false, nextDiceBonus:0, avoidPoorGod:false, nextTurnDouble:false, movesLeft:1},
];

let currentPlayerIndex = 0;
let turnCount = 1;
const maxTurns = 20; // 20å¹´ã§ã‚²ãƒ¼ãƒ çµ‚äº†

let poorGodPosition = -1; // è²§ä¹ç¥åˆæœŸã¯ã©ã“ã«ã‚‚ã„ãªã„

let gameState = "waiting"; // waiting, rolling, quiz, buying, ended

// === DOM ===
const canvas = document.getElementById("mapCanvas");
const ctx = canvas.getContext("2d");

const rollDiceBtn = document.getElementById("rollDiceBtn");
const endTurnBtn = document.getElementById("endTurnBtn");
const buyPropertyBtn = document.getElementById("buyPropertyBtn");

const playerInfoDiv = document.getElementById("player-info");
const logDiv = document.getElementById("log");

const cardsDiv = document.getElementById("cards");

const quizBox = document.getElementById("quiz-box");
const quizQuestionP = document.getElementById("quiz-question");
const quizAnswerInput = document.getElementById("quiz-answer");
const submitQuizBtn = document.getElementById("submitQuizBtn");
const quizFeedbackP = document.getElementById("quiz-feedback");

// === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
function log(text) {
  logDiv.innerHTML += text + "<br>";
  logDiv.scrollTop = logDiv.scrollHeight;
}

function drawStation(station, idx) {
  const radius = 15;
  ctx.beginPath();
  ctx.fillStyle = "white";
  ctx.strokeStyle = "#333";
  ctx.lineWidth = 2;
  ctx.arc(station.x, station.y, radius, 0, Math.PI * 2);
  ctx.fill();
  ctx.stroke();

  // æ‰€æŒè€…ã®è‰²ã§ç¸å–ã‚Š
  if (station.owner !== undefined) {
    ctx.strokeStyle = players[station.owner].color;
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(station.x, station.y, radius - 3, 0, Math.PI * 2);
    ctx.stroke();
  }

  // é§…å
  ctx.fillStyle = "#004080";
  ctx.font = "12px 'Segoe UI'";
  ctx.textAlign = "center";
  ctx.fillText(station.name, station.x, station.y - radius - 5);

  // å€¤æ®µè¡¨ç¤º
  ctx.fillStyle = "#0078d7";
  ctx.font = "10px 'Segoe UI'";
  ctx.fillText(station.price + "å††", station.x, station.y + radius + 12);

  // è²§ä¹ç¥è¡¨ç¤º
  if (poorGodPosition === idx) {
    ctx.fillStyle = "black";
    ctx.font = "20px 'Segoe UI'";
    ctx.fillText("ğŸ‘¹", station.x, station.y + 5);
  }
}

function drawPlayers() {
  players.forEach((p, i) => {
    const station = stations[p.position];
    const radius = 8;
    const offsetX = (i % 2) * 18 - 9;
    const offsetY = Math.floor(i / 2) * 18 - 9;
    ctx.beginPath();
    ctx.fillStyle = p.color;
    ctx.arc(station.x + offsetX, station.y + offsetY, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = "white";
    ctx.lineWidth = 2;
    ctx.stroke();
  });
}

function drawMap() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  stations.forEach((station, idx) => drawStation(station, idx));
  drawPlayers();
}

// ç¾ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—
function get currentPlayer() { return players[currentPlayerIndex]; }

// UIæ›´æ–°
function updateUI() {
  const p = currentPlayer;
  let html = `<b>ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1} (${p.name})</b><br>`;
  html += `ã‚¿ãƒ¼ãƒ³æ•°: ${turnCount} / ${maxTurns}<br>`;
  html += `æ‰€æŒé‡‘: ${p.money} å††<br>`;
  html += `ç¾åœ¨åœ°: ${stations[p.position].name}<br>`;
  html += `ç‰©ä»¶: ${p.properties.length === 0 ? "ãªã—" : p.properties.map(i => stations[i].name).join(", ")}<br>`;
  playerInfoDiv.innerHTML = html;

  buyPropertyBtn.disabled = gameState !== "buying";
  endTurnBtn.disabled = gameState !== "waiting" && gameState !== "buying";

  rollDiceBtn.disabled = gameState !== "waiting";
  cardsDiv.innerHTML = "";
  p.cards.forEach((card, i) => {
    const c = document.createElement("div");
    c.className = "card";
    c.textContent = card.name;
    c.title = card.desc;
    c.onclick = () => {
      if (card.used) return;
      card.effect(game);
      card.used = true;
      c.classList.add("used");
      log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1}ãŒã‚«ãƒ¼ãƒ‰ã€Œ${card.name}ã€ã‚’ä½¿ã£ãŸï¼`);
      updateUI();
    };
    cardsDiv.appendChild(c);
  });

  if (gameState === "quiz") {
    quizBox.style.display = "block";
    quizAnswerInput.value = "";
    quizFeedbackP.textContent = "";
    quizAnswerInput.focus();
  } else {
    quizBox.style.display = "none";
  }
}

// ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ï¼ˆ1ã€œ6ï¼‰
function rollDice() {
  let base = Math.floor(Math.random() * 6) + 1;
  const p = currentPlayer;
  if (p.nextDiceBonus) {
    base += p.nextDiceBonus;
    p.nextDiceBonus = 0;
  }
  if (base > 6) base = 6;
  log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1}ã®ã‚µã‚¤ã‚³ãƒ­ã®ç›®ã¯ ${base} ï¼`);
  return base;
}

// ç§»å‹•å‡¦ç†
function movePlayer(steps) {
  const p = currentPlayer;
  p.position += steps;
  if (p.position >= stations.length) {
    p.position = p.position % stations.length;
    log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1}ã¯ä¸€å‘¨ã—ã¾ã—ãŸï¼`);
  }
  drawMap();
  checkStationEvent();
}

// é§…ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
function checkStationEvent() {
  const p = currentPlayer;
  const pos = p.position;
  const station = stations[pos];

  // è²§ä¹ç¥ãŒã„ã‚‹å ´åˆ
  if (poorGodPosition === pos && !p.avoidPoorGod) {
    const loss = Math.min(1000, p.money);
    p.money -= loss;
    log(`ğŸ’€ è²§ä¹ç¥ãŒè¥²æ¥ï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1}ã¯${loss}å††å¤±ã£ãŸï¼`);
  } else if (poorGodPosition === pos && p.avoidPoorGod) {
    log(`ğŸ‘¹ è²§ä¹ç¥è¥²æ¥ã‚’ã‚«ãƒ¼ãƒ‰ã§å›é¿ï¼`);
    p.avoidPoorGod = false;
  }

  // ã‚¯ã‚¤ã‚ºé§…
  if (quizzes[station.name]) {
    log(`ğŸ“ ã‚¯ã‚¤ã‚ºé§…ã€Œ${station.name}ã€ã«åˆ°ç€ï¼ã‚¯ã‚¤ã‚ºã«ç­”ãˆã‚ˆã†ï¼`);
    gameState = "quiz";
    updateUI();
    return;
  }

  // ç‰©ä»¶è³¼å…¥å¯èƒ½
  if (station.owner === undefined) {
    log(`ğŸ  ã€Œ${station.name}ã€ã¯ã¾ã è³¼å…¥ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è³¼å…¥ã§ãã¾ã™ã€‚`);
    gameState = "buying";
    updateUI();
  } else if (station.owner !== currentPlayerIndex) {
    // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç‰©ä»¶ã®å ´åˆã¯é€šéæ–™ã‚’æ”¯æ‰•ã†
    const fee = Math.floor(station.price * 0.3);
    p.money -= fee;
    players[station.owner].money += fee;
    log(`ğŸ’° ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1}ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${station.owner + 1}ã®ç‰©ä»¶ã€Œ${station.name}ã€ã«æ­¢ã¾ã‚Šã€${fee}å††ã®é€šéæ–™ã‚’æ”¯æ‰•ã£ãŸã€‚`);
    gameState = "waiting";
    updateUI();
  } else {
    log(`ğŸ  è‡ªåˆ†ã®ç‰©ä»¶ã€Œ${station.name}ã€ã«åˆ°ç€ã€‚`);
    gameState = "waiting";
    updateUI();
  }
}

// ã‚¯ã‚¤ã‚ºå›ç­”å‡¦ç†
function submitQuiz() {
  const p = currentPlayer;
  const station = stations[p.position];
  const quiz = quizzes[station.name];
  const answer = quizAnswerInput.value.trim();
  if (!answer) return;

  // æ­£èª¤åˆ¤å®šï¼ˆå®Œå…¨ä¸€è‡´ or å¤§æ–‡å­—å°æ–‡å­—ç„¡è¦–ï¼‰
  if (answer === quiz.answer || answer.toLowerCase() === quiz.answer.toLowerCase()) {
    const basePoint = 1000;
    const point = p.nextQuizDouble ? basePoint * 2 : basePoint;
    p.money += point;
    log(`âœ… æ­£è§£ï¼${point}å††ã‚²ãƒƒãƒˆï¼`);
    p.nextQuizDouble = false;
  } else {
    log(`âŒ ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${quiz.answer}ã€ã§ã™ã€‚`);
  }
  gameState = "waiting";
  updateUI();
}

// ç‰©ä»¶è³¼å…¥å‡¦ç†
function buyProperty() {
  const p = currentPlayer;
  const pos = p.position;
  const station = stations[pos];
  if (station.owner !== undefined) {
    alert("ã™ã§ã«èª°ã‹ãŒæ‰€æœ‰ã—ã¦ã„ã¾ã™ï¼");
    return;
  }
  if (p.money < station.price) {
    alert("æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
    return;
  }
  p.money -= station.price;
  station.owner = currentPlayerIndex;
  p.properties.push(pos);
  log(`ğŸ  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1}ãŒã€Œ${station.name}ã€ã‚’è³¼å…¥ã—ã¾ã—ãŸã€‚`);
  gameState = "waiting";
  updateUI();
}

// ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†
function endTurn() {
  let p = currentPlayer;

  // æ¬¡ã‚¿ãƒ¼ãƒ³2å›è¡Œå‹•ãƒã‚§ãƒƒã‚¯
  if (p.nextTurnDouble) {
    p.nextTurnDouble = false;
    p.movesLeft = 2;
    log(`ğŸ‰ æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¯2å›è¡Œå‹•ã§ãã¾ã™ï¼`);
  } else {
    p.movesLeft = 1;
  }

  currentPlayerIndex++;
  if (currentPlayerIndex >= players.length) {
    currentPlayerIndex = 0;
    turnCount++;
    // è²§ä¹ç¥ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç§»å‹•
    movePoorGod();
  }

  if (turnCount > maxTurns) {
    gameState = "ended";
    endGame();
  } else {
    gameState = "waiting";
    updateUI();
    log(`-----------------------`);
    log(`ğŸ¯ ã‚¿ãƒ¼ãƒ³ ${turnCount} é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1}ã®ç•ª`);
  }
}

// è²§ä¹ç¥ç§»å‹•
function movePoorGod() {
  if (poorGodPosition === -1) {
    poorGodPosition = Math.floor(Math.random() * stations.length);
    log(`ğŸ‘¹ è²§ä¹ç¥ãŒã€Œ${stations[poorGodPosition].name}ã€ã«ç¾ã‚ŒãŸï¼`);
  } else {
    let newPos;
    do {
      newPos = Math.floor(Math.random() * stations.length);
    } while (newPos === poorGodPosition);
    poorGodPosition = newPos;
    log(`ğŸ‘¹ è²§ä¹ç¥ãŒã€Œ${stations[poorGodPosition].name}ã€ã«ç§»å‹•ã—ãŸï¼`);
  }
  drawMap();
}

// ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
function endGame() {
  let winner = players[0];
  players.forEach(p => {
    if (p.money > winner.money) winner = p;
  });
  log(`ğŸ† ã‚²ãƒ¼ãƒ çµ‚äº†ï¼å‹è€…ã¯ ${winner.name}ï¼æ‰€æŒé‡‘: ${winner.money}å††`);
  alert(`ã‚²ãƒ¼ãƒ çµ‚äº†ï¼å‹è€…ã¯ ${winner.name} ã§ã™ï¼`);
  rollDiceBtn.disabled = true;
  buyPropertyBtn.disabled = true;
  endTurnBtn.disabled = true;
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²
rollDiceBtn.onclick = () => {
  if (gameState !== "waiting") return;
  const dice = rollDice();
  movePlayer(dice);
  rollDiceBtn.disabled = true;
  endTurnBtn.disabled = false;
};

submitQuizBtn.onclick = () => {
  if (gameState !== "quiz") return;
  submitQuiz();
};

buyPropertyBtn.onclick = () => {
  if (gameState !== "buying") return;
  buyProperty();
};

endTurnBtn.onclick = () => {
  if (gameState !== "waiting" && gameState !== "buying") return;
  endTurn();
  rollDiceBtn.disabled = false;
  endTurnBtn.disabled = true;
};

// ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰åŠ¹æœã«ä½¿ã†ï¼‰
const game = {
  currentPlayer: null
};

// ã‚²ãƒ¼ãƒ é–‹å§‹
function startGame() {
  game.currentPlayer = players[currentPlayerIndex];
  log(`ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${players.length}`);
  log(`-----------------------`);
  log(`ğŸ¯ ã‚¿ãƒ¼ãƒ³ ${turnCount} é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerIndex + 1}ã®ç•ª`);
  gameState = "waiting";
  updateUI();
  drawMap();
}

startGame();

// UIã®å¸¸æ™‚æ›´æ–°
setInterval(() => {
  game.currentPlayer = players[currentPlayerIndex];
  updateUI();
}, 1000);

</script>
</body>
</html>
